# Test Suite Makefile
# Builds and runs unit tests for AMDGPU_Abstracted

CC = gcc
CFLAGS = -std=c99 -Wall -Wextra -I.. -I../core -I../core/hal -I../core/rmapi -I../core/ipc -I../os -I../os/linux -I../drivers/amdgpu

# Detect OS and add appropriate libraries
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Haiku)
    CC = clang
    LDFLAGS = -lm -lroot -lnetwork
    CFLAGS += -I/boot/system/develop/headers -I/boot/system/develop/headers/posix
    OS_PRIMS = ../../os/haiku/os_primitives_haiku.o
    OS_IFACE = ../../os/haiku/os_interface_haiku.o
else
    LDFLAGS = -lm -pthread
    OS_PRIMS = ../../os/linux/os_primitives_linux.o
    OS_IFACE = ../../os/linux/os_interface_linux.o
endif

# Allow multiple definitions (for test compilation)
LDFLAGS += -Wl,--allow-multiple-definition

# Test sources
TEST_SOURCES = test_runner.c test_gmc_v10.c
TEST_OBJS = $(TEST_SOURCES:.c=.o)

# Core driver objects needed for testing (built by main Makefile)
# These should be pre-built by the main Makefile - we just list them here
DRIVER_OBJS = ../../core/hal/hal.o ../../core/resource/resserv.o ../../drivers/amdgpu/ip_blocks/gmc_v10.o ../../drivers/amdgpu/ip_blocks/gfx_v10.o \
              ../../core/ipc/ipc_lib.o \
              $(OS_PRIMS) $(OS_IFACE)

# Test executable
TEST_BIN = test_suite

# Default target
all: $(TEST_BIN)

# Build test executable
$(TEST_BIN): $(TEST_OBJS)
	$(CC) $(CFLAGS) -o $@ $^ $(DRIVER_OBJS) $(LDFLAGS)
	@echo "✅ Test suite built: $(TEST_BIN)"

# Compile test source files
test_runner.o: test_runner.c test_framework.h
	$(CC) $(CFLAGS) -c $< -o $@

test_gmc_v10.o: test_gmc_v10.c test_framework.h
	$(CC) $(CFLAGS) -c $< -o $@

# Run tests
test: $(TEST_BIN)
	@echo ""
	@echo "Running tests..."
	@echo ""
	./$(TEST_BIN)

# Run tests with verbose output
test-verbose: $(TEST_BIN)
	./$(TEST_BIN) -v

# Run tests with coverage
test-coverage: CFLAGS += --coverage
test-coverage: LDFLAGS += --coverage
test-coverage: clean $(TEST_BIN)
	@echo "Running tests with coverage..."
	./$(TEST_BIN)
	@echo "Generating coverage report..."
	gcov $(TEST_SOURCES) $(DRIVER_SOURCES)
	@echo "Coverage data written to *.gcov files"

# Run tests with memory checking (valgrind)
test-memory: $(TEST_BIN)
	@echo "Running tests with memory checking..."
	@echo ""
	valgrind --leak-check=full --show-leak-kinds=all ./$(TEST_BIN)

# Run tests with AddressSanitizer
test-asan: CFLAGS += -fsanitize=address -fno-omit-frame-pointer
test-asan: LDFLAGS += -fsanitize=address
test-asan: clean $(TEST_BIN)
	@echo "Running tests with AddressSanitizer..."
	./$(TEST_BIN)

# Clean build artifacts
clean:
	rm -f $(TEST_BIN) $(TEST_OBJS)
	rm -f *.gcov *.gcda *.gcno
	@echo "✅ Cleaned test artifacts"

# Help target
help:
	@echo "Test Suite Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  make test              - Build and run tests"
	@echo "  make test-verbose      - Run tests with verbose output"
	@echo "  make test-coverage     - Run tests with gcov coverage"
	@echo "  make test-memory       - Run tests with valgrind memory check"
	@echo "  make test-asan         - Run tests with AddressSanitizer"
	@echo "  make clean             - Clean build artifacts"
	@echo "  make help              - Show this help message"
	@echo ""

.PHONY: all test test-verbose test-coverage test-memory test-asan clean help
